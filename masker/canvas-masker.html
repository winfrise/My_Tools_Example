<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>è§†é¢‘é®ç½© Demo - Fabric.js</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .demo-container {
      margin-bottom: 40px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .toolbar {
      margin: 10px 0;
    }
    button {
      padding: 6px 12px;
      margin-right: 8px;
      cursor: pointer;
    }
    canvas {
      border: 1px solid #ddd;
      background: #000;
    }
    h2 {
      margin-top: 0;
      color: #333;
    }
    video {
      display: none; /* è§†é¢‘å…ƒç´ éšè— */
    }
  </style>
</head>
<body>

  <!-- Demo 1: å¤šåŒºåŸŸé®ç½© -->
  <div class="demo-container">
    <h2>ğŸ“Œ Demo 1ï¼šå¤šåŒºåŸŸå¯è§é®ç½©ï¼ˆå¯æ·»åŠ å¤šä¸ªï¼‰</h2>
    <div class="toolbar">
      <button id="addRect1">æ·»åŠ çŸ©å½¢</button>
      <button id="addCircle1">æ·»åŠ åœ†å½¢</button>
      <button id="delete1">åˆ é™¤é€‰ä¸­</button>
    </div>
    <canvas id="canvas1" width="700" height="500"></canvas>
    <video id="video1" width="700" height="500" controls>
      <source src="your-video.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <!-- Demo 2: æ‰‹ç”µç­’æ•ˆæœ -->
  <div class="demo-container">
    <h2>ğŸ”¦ Demo 2ï¼šæ‰‹ç”µç­’é®ç½©ï¼ˆå•åŒºåŸŸï¼Œå¯æ‹–åŠ¨ï¼‰</h2>
    <p>æ‹–åŠ¨åœ†å½¢åŒºåŸŸæŸ¥çœ‹è§†é¢‘ï¼Œç‚¹å‡»ç”»å¸ƒå¯å¿«é€Ÿå®šä½</p>
    <canvas id="canvas2" width="700" height="500"></canvas>
    <video id="video2" width="700" height="500" controls>
      <source src="your-video.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <script>
    // å…¬å…±ï¼šåŠ è½½èƒŒæ™¯è§†é¢‘å¹¶ç»˜åˆ¶åˆ°Canvas
    function loadBackgroundVideo(canvas, videoId) {
      const video = document.getElementById(videoId);
      video.play(); // è‡ªåŠ¨æ’­æ”¾è§†é¢‘

      function drawFrame() {
        if (!canvas.backgroundImage) {
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          setTimeout(drawFrame, 1000 / 30); // æ¯ç§’çº¦30å¸§
        }
      }

      drawFrame();
    }

    // ========================
    // ğŸ”¹ Demo 1: å¤šåŒºåŸŸé®ç½©
    // ========================
    const canvas1 = new fabric.Canvas('canvas1', {
      backgroundColor: '#000',
      selection: true,
    });

    loadBackgroundVideo(canvas1, 'video1');

    function createClippedImageForCanvas1(shapeType, options) {
      let clipPath;
      if (shapeType === 'rect') {
        clipPath = new fabric.Rect({
          width: options.width,
          height: options.height,
          left: -options.width / 2,
          top: -options.height / 2,
          absolutePositioned: true,
        });
      } else {
        clipPath = new fabric.Circle({
          radius: options.radius,
          left: -options.radius,
          top: -options.radius,
          absolutePositioned: true,
        });
      }

      const clipped = new fabric.Image(document.getElementById('video1'), {
        left: options.left,
        top: options.top,
        width: 700,
        height: 500,
        selectable: true,
        hasControls: true,
        clipPath: clipPath,
      });

      return clipped;
    }

    document.getElementById('addRect1').addEventListener('click', () => {
      const obj = createClippedImageForCanvas1('rect', {
        left: 200, top: 150, width: 150, height: 100
      });
      if (obj) canvas1.add(obj);
    });

    document.getElementById('addCircle1').addEventListener('click', () => {
      const obj = createClippedImageForCanvas1('circle', {
        left: 400, top: 200, radius: 60
      });
      if (obj) canvas1.add(obj);
    });

    document.getElementById('delete1').addEventListener('click', () => {
      const active = canvas1.getActiveObject();
      if (active) canvas1.remove(active);
    });

    // ========================
    // ğŸ”¸ Demo 2: æ‰‹ç”µç­’æ•ˆæœ
    // ========================
    const canvas2 = new fabric.Canvas('canvas2', {
      backgroundColor: '#000',
      selection: false, // ç¦ç”¨æ¡†é€‰
    });

    let flashlightObj = null;

    loadBackgroundVideo(canvas2, 'video2');

    const radius = 100;
    const clipPath = new fabric.Circle({
      radius: radius,
      left: -radius,
      top: -radius,
      absolutePositioned: true,
    });

    flashlightObj = new fabric.Image(document.getElementById('video2'), {
      left: canvas2.width / 2,
      top: canvas2.height / 2,
      width: 700,
      height: 500,
      selectable: true,
      hasControls: false, // éšè—æ§åˆ¶ç‚¹ï¼Œæ›´åƒæ‰‹ç”µç­’
      hoverCursor: 'move',
      clipPath: clipPath,
    });

    canvas2.add(flashlightObj);

    // ç‚¹å‡»ç”»å¸ƒå¿«é€Ÿå®šä½æ‰‹ç”µç­’
    canvas2.on('mouse:down', (opt) => {
      if (!flashlightObj) return;
      const pointer = canvas2.getPointer(opt.e);
      flashlightObj.set({
        left: pointer.x,
        top: pointer.y,
      });
      canvas2.renderAll();
    });

    // æ‹–åŠ¨æ‰‹ç”µç­’ï¼ˆå·²ç”± Fabric è‡ªåŠ¨æ”¯æŒï¼Œå›  selectable=trueï¼‰
  </script>
</body>
</html>